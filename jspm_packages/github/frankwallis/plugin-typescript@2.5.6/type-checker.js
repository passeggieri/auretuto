/* */ 
System.register(['typescript', './logger', './utils', "./compiler-host"], function(exports_1) {
    var ts, logger_1, utils_1, compiler_host_1;
    var logger, TypeChecker;
    return {
        setters:[
            function (ts_1) {
                ts = ts_1;
            },
            function (logger_1_1) {
                logger_1 = logger_1_1;
            },
            function (utils_1_1) {
                utils_1 = utils_1_1;
            },
            function (compiler_host_1_1) {
                compiler_host_1 = compiler_host_1_1;
            }],
        execute: function() {
            logger = new logger_1.default({ debug: false });
            TypeChecker = (function () {
                function TypeChecker(host) {
                    this._host = host;
                    this._options = ts.clone(this._host.options);
                    this._options.inlineSourceMap = false;
                    this._options.sourceMap = false;
                    this._options.declaration = false;
                    this._options.isolatedModules = false;
                    this._options.skipDefaultLibCheck = true;
                }
                TypeChecker.prototype.check = function () {
                    var candidates = this.getCandidates();
                    if (candidates.some(function (candidate) { return candidate.checkable && !utils_1.isTypescriptDeclaration(candidate.name); }))
                        return this.getAllDiagnostics(candidates);
                    else
                        return [];
                };
                TypeChecker.prototype.forceCheck = function () {
                    var files = this._host.getAllFiles()
                        .filter(function (file) { return file.fileName != compiler_host_1.__HTML_MODULE__; });
                    var unchecked = files.filter(function (file) { return !file.checked; });
                    var errored = files.filter(function (file) { return file.checked && utils_1.hasError(file.errors); });
                    if ((errored.length > 0) || (unchecked.length > 0)) {
                        return [{
                                file: undefined,
                                start: undefined,
                                length: undefined,
                                code: 9999,
                                category: ts.DiagnosticCategory.Error,
                                messageText: "compilation failed [" + files.length + " files, " + errored.length + " failed, " + unchecked.length + " unchecked]"
                            }];
                    }
                    return [];
                };
                TypeChecker.prototype.getCandidates = function () {
                    var _this = this;
                    var candidates = this._host.getAllFiles()
                        .filter(function (file) { return file.fileName != compiler_host_1.__HTML_MODULE__; })
                        .map(function (file) { return ({
                        name: file.fileName,
                        file: file,
                        seen: false,
                        resolved: !!file.dependencies,
                        checkable: undefined,
                        deps: file.dependencies && file.dependencies.list
                    }); });
                    var candidatesMap = candidates.reduce(function (result, candidate) {
                        result[candidate.name] = candidate;
                        return result;
                    }, {});
                    candidates.forEach(function (candidate) { return candidate.checkable = _this.isCheckable(candidate, candidatesMap); });
                    return candidates;
                };
                TypeChecker.prototype.isCheckable = function (candidate, candidatesMap) {
                    var _this = this;
                    if (!candidate)
                        return false;
                    else {
                        if (!candidate.seen) {
                            candidate.seen = true;
                            candidate.checkable = candidate.resolved && candidate.deps.every(function (dep) { return _this.isCheckable(candidatesMap[dep], candidatesMap); });
                        }
                        return (candidate.checkable !== false);
                    }
                };
                TypeChecker.prototype.getAllDiagnostics = function (candidates) {
                    var filelist = candidates.map(function (dep) { return dep.name; }).concat([compiler_host_1.__HTML_MODULE__]);
                    var program = ts.createProgram(filelist, this._options, this._host);
                    return candidates.reduce(function (errors, candidate) {
                        if (candidate.checkable && !candidate.file.checked) {
                            candidate.file.errors = [];
                            if (!candidate.file.isLibFile) {
                                candidate.file.errors = program.getSyntacticDiagnostics(candidate.file)
                                    .concat(program.getSemanticDiagnostics(candidate.file));
                            }
                            candidate.file.checked = true;
                            return errors.concat(candidate.file.errors);
                        }
                        else {
                            return errors;
                        }
                    }, program.getGlobalDiagnostics());
                };
                return TypeChecker;
            })();
            exports_1("TypeChecker", TypeChecker);
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwZS1jaGVja2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3R5cGUtY2hlY2tlci50cyJdLCJuYW1lcyI6WyJUeXBlQ2hlY2tlciIsIlR5cGVDaGVja2VyLmNvbnN0cnVjdG9yIiwiVHlwZUNoZWNrZXIuY2hlY2siLCJUeXBlQ2hlY2tlci5mb3JjZUNoZWNrIiwiVHlwZUNoZWNrZXIuZ2V0Q2FuZGlkYXRlcyIsIlR5cGVDaGVja2VyLmlzQ2hlY2thYmxlIiwiVHlwZUNoZWNrZXIuZ2V0QWxsRGlhZ25vc3RpY3MiXSwibWFwcGluZ3MiOiI7O1FBT00sTUFBTTs7Ozs7Ozs7Ozs7Ozs7OztZQUFOLE1BQU0sR0FBRyxJQUFJLGdCQUFNLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztZQWE1QztnQkFJQ0EscUJBQVlBLElBQWtCQTtvQkFDN0JDLElBQUlBLENBQUNBLEtBQUtBLEdBQUdBLElBQUlBLENBQUNBO29CQUVkQSxJQUFJQSxDQUFDQSxRQUFRQSxHQUFTQSxFQUFHQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtvQkFDeERBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLGVBQWVBLEdBQUdBLEtBQUtBLENBQUNBO29CQUN0Q0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsU0FBU0EsR0FBR0EsS0FBS0EsQ0FBQ0E7b0JBQ2hDQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxXQUFXQSxHQUFHQSxLQUFLQSxDQUFDQTtvQkFDbENBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLGVBQWVBLEdBQUdBLEtBQUtBLENBQUNBO29CQUN0Q0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsbUJBQW1CQSxHQUFHQSxJQUFJQSxDQUFDQTtnQkFDMUNBLENBQUNBO2dCQUtNRCwyQkFBS0EsR0FBWkE7b0JBQ0tFLElBQU1BLFVBQVVBLEdBQUdBLElBQUlBLENBQUNBLGFB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QSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxHQUFHQSxJQUFJQSxDQUFDQTs0QkFDdEJBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLFNBQVNBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO3dCQUNyREEsQ0FBQ0E7d0JBQ0tBLElBQUlBLENBQUNBLENBQUNBOzRCQUNIQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQTt3QkFDakJBLENBQUNBO29CQUNSQSxDQUFDQSxFQUFFQSxPQUFPQSxDQUFDQSxvQkFBb0JBLEVBQUVBLENBQUNBLENBQUNBO2dCQUNwQ0EsQ0FBQ0E7Z0JBQ0ZOLGtCQUFDQTtZQUFEQSxDQUFDQSxBQTdHRCxJQTZHQztZQTdHRCxxQ0E2R0MsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qICovXHJcbmltcG9ydCAqIGFzIHRzIGZyb20gJ3R5cGVzY3JpcHQnO1xyXG5pbXBvcnQgTG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcclxuaW1wb3J0IHtpc1R5cGVzY3JpcHREZWNsYXJhdGlvbiwgaGFzRXJyb3J9IGZyb20gJy4vdXRpbHMnO1xyXG5pbXBvcnQge0NvbXBpbGVySG9zdCwgQ29tYmluZWRPcHRpb25zLCBTb3VyY2VGaWxlfSBmcm9tICcuL2NvbXBpbGVyLWhvc3QnO1xyXG5pbXBvcnQge19fSFRNTF9NT0RVTEVfX30gZnJvbSBcIi4vY29tcGlsZXItaG9zdFwiO1xyXG5cclxuY29uc3QgbG9nZ2VyID0gbmV3IExvZ2dlcih7IGRlYnVnOiBmYWxzZSB9KTtcclxuXHJcbnR5cGUgQ2FuZGlkYXRlID0ge1xyXG4gICBuYW1lOiBzdHJpbmc7XHJcbiAgIGZpbGU6IFNvdXJjZUZpbGU7ICAgXHJcbiAgIHNlZW46IGJvb2xlYW47XHJcbiAgIHJlc29sdmVkOiBib29sZWFuO1xyXG4gICBkZXBzOiBzdHJpbmdbXTtcclxuICAgY2hlY2thYmxlOiBib29sZWFuO1xyXG59XHJcblxyXG50eXBlIENhbmRpZGF0ZU1hcCA9IHsgW3M6IHN0cmluZ106IENhbmRpZGF0ZSB9O1xyXG5cclxuZXhwb3J0IGNsYXNzIFR5cGVDaGVja2VyIHtcclxuXHRwcml2YXRlIF9ob3N0OiBDb21waWxlckhvc3Q7XHJcbiAgIHByaXZhdGUgX29wdGlvbnM6IENvbWJpbmVkT3B0aW9ucztcclxuXHJcblx0Y29uc3RydWN0b3IoaG9zdDogQ29tcGlsZXJIb3N0KSB7XHJcblx0XHR0aGlzLl9ob3N0ID0gaG9zdDtcclxuXHJcbiAgICAgIHRoaXMuX29wdGlvbnMgPSAoPGFueT50cykuY2xvbmUodGhpcy5faG9zdC5vcHRpb25zKTtcclxuXHRcdHRoaXMuX29wdGlvbnMuaW5saW5lU291cmNlTWFwID0gZmFsc2U7XHJcblx0XHR0aGlzLl9vcHRpb25zLnNvdXJjZU1hcCA9IGZhbHNlO1xyXG5cdFx0dGhpcy5fb3B0aW9ucy5kZWNsYXJhdGlvbiA9IGZhbHNlO1xyXG5cdFx0dGhpcy5fb3B0aW9ucy5pc29sYXRlZE1vZHVsZXMgPSBmYWxzZTtcclxuXHRcdHRoaXMuX29wdGlvbnMuc2tpcERlZmF1bHRMaWJDaGVjayA9IHRydWU7IC8vIGRvbid0IGNoZWNrIHRoZSBkZWZhdWx0IGxpYiBmb3IgYmV0dGVyIHBlcmZvcm1hbmNlXHJcblx0fVxyXG5cclxuXHQvKlxyXG5cdFx0cmV0dXJucyBhIHByb21pc2UgdG8gYW4gYXJyYXkgb2YgdHlwZXNjcmlwdCBlcnJvcnMgZm9yIHRoaXMgZmlsZVxyXG5cdCovXHJcblx0cHVibGljIGNoZWNrKCk6IHRzLkRpYWdub3N0aWNbXSB7ICAgICAgICAgXHJcbiAgICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSB0aGlzLmdldENhbmRpZGF0ZXMoKTtcclxuICAgICAgaWYgKGNhbmRpZGF0ZXMuc29tZShjYW5kaWRhdGUgPT4gY2FuZGlkYXRlLmNoZWNrYWJsZSAmJiAhaXNUeXBlc2NyaXB0RGVjbGFyYXRpb24oY2FuZGlkYXRlLm5hbWUpKSkgICAgICAgICAgICBcclxuICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QWxsRGlhZ25vc3RpY3MoY2FuZGlkYXRlcyk7IFxyXG4gICAgICBlbHNlXHJcbiAgICAgICAgIHJldHVybiBbXTtcclxuXHR9XHJcblxyXG5cdC8qXHJcblx0XHR0aHJvd3MgaWYgdGhlcmUgYXJlIGNvbXBpbGVyIGVycm9ycyBvciB1bnJlc29sdmVkIGZpbGVzXHJcblx0Ki9cclxuXHRwdWJsaWMgZm9yY2VDaGVjaygpOiB0cy5EaWFnbm9zdGljW10ge1xyXG4gICAgICBjb25zdCBmaWxlcyA9IHRoaXMuX2hvc3QuZ2V0QWxsRmlsZXMoKVxyXG4gICAgICAgICAuZmlsdGVyKGZpbGUgPT4gZmlsZS5maWxlTmFtZSAhPSBfX0hUTUxfTU9EVUxFX18pO1xyXG4gICAgICBjb25zdCB1bmNoZWNrZWQgPSBmaWxlcy5maWx0ZXIoZmlsZSA9PiAhZmlsZS5jaGVja2VkKTtcclxuICAgICAgY29uc3QgZXJyb3JlZCA9IGZpbGVzLmZpbHRlcihmaWxlID0+IGZpbGUuY2hlY2tlZCAmJiBoYXNFcnJvcihmaWxlLmVycm9ycykpO1xyXG4gICAgICBcclxuICAgICAgaWYgKChlcnJvcmVkLmxlbmd0aCA+IDApIHx8ICh1bmNoZWNrZWQubGVuZ3RoID4gMCkpIHtcclxuICAgICAgICAgcmV0dXJuIFt7XHJcbiAgICAgICAgICAgIGZpbGU6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgc3RhcnQ6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgbGVuZ3RoOiB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgIGNvZGU6IDk5OTksXHJcbiAgICAgICAgICAgIGNhdGVnb3J5OiB0cy5EaWFnbm9zdGljQ2F0ZWdvcnkuRXJyb3IsXHJcbiAgICAgICAgICAgIG1lc3NhZ2VUZXh0OiBgY29tcGlsYXRpb24gZmFpbGVkIFske2ZpbGVzLmxlbmd0aH0gZmlsZXMsICR7ZXJyb3JlZC5sZW5ndGh9IGZhaWxlZCwgJHt1bmNoZWNrZWQubGVuZ3RofSB1bmNoZWNrZWRdYFxyXG4gICAgICAgICB9XTtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgcmV0dXJuIFtdOyBcclxuXHR9XHJcblxyXG4gICBwcml2YXRlIGdldENhbmRpZGF0ZXMoKSB7XHJcbiAgICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSB0aGlzLl9ob3N0LmdldEFsbEZpbGVzKClcclxuICAgICAgICAgLmZpbHRlcihmaWxlID0+IGZpbGUuZmlsZU5hbWUgIT0gX19IVE1MX01PRFVMRV9fKVxyXG4gICAgICAgICAubWFwKGZpbGUgPT4gKHtcclxuICAgICAgICAgICAgbmFtZTogZmlsZS5maWxlTmFtZSxcclxuICAgICAgICAgICAgZmlsZTogZmlsZSxcclxuICAgICAgICAgICAgc2VlbjogZmFsc2UsXHJcbiAgICAgICAgICAgIHJlc29sdmVkOiAhIWZpbGUuZGVwZW5kZW5jaWVzLFxyXG4gICAgICAgICAgICBjaGVja2FibGU6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgZGVwczogZmlsZS5kZXBlbmRlbmNpZXMgJiYgZmlsZS5kZXBlbmRlbmNpZXMubGlzdFxyXG4gICAgICAgICB9KSk7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCBjYW5kaWRhdGVzTWFwID0gY2FuZGlkYXRlcy5yZWR1Y2UoKHJlc3VsdCwgY2FuZGlkYXRlKSA9PiB7XHJcbiAgICAgICAgIHJlc3VsdFtjYW5kaWRhdGUubmFtZV0gPSBjYW5kaWRhdGU7XHJcbiAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgIH0sIHt9IGFzIENhbmRpZGF0ZU1hcCk7XHJcbiAgICAgIFxyXG4gICAgICBjYW5kaWRhdGVzLmZvckVhY2goY2FuZGlkYXRlID0+IGNhbmRpZGF0ZS5jaGVja2FibGUgPSB0aGlzLmlzQ2hlY2thYmxlKGNhbmRpZGF0ZSwgY2FuZGlkYXRlc01hcCkpO1xyXG4gICAgICByZXR1cm4gY2FuZGlkYXRlcztcclxuICAgfVxyXG4gICBcclxuICAgcHJpdmF0ZSBpc0NoZWNrYWJsZShjYW5kaWRhdGU6IENhbmRpZGF0ZSwgY2FuZGlkYXRlc01hcDogQ2FuZGlkYXRlTWFwKTogYm9vbGVhbiB7XHJcbiAgICAgIGlmICghY2FuZGlkYXRlKVxyXG4gICAgICAgICByZXR1cm4gZmFsc2U7ICAgICAgXHJcbiAgICAgIGVsc2Uge1xyXG4gICAgICAgICBpZiAoIWNhbmRpZGF0ZS5zZWVuKSB7XHJcbiAgICAgICAgICAgIGNhbmRpZGF0ZS5zZWVuID0gdHJ1ZTtcclxuICAgICAgICAgICAgY2FuZGlkYXRlLmNoZWNrYWJsZSA9IGNhbmRpZGF0ZS5yZXNvbHZlZCAmJiBjYW5kaWRhdGUuZGVwcy5ldmVyeShkZXAgPT4gdGhpcy5pc0NoZWNrYWJsZShjYW5kaWRhdGVzTWFwW2RlcF0sIGNhbmRpZGF0ZXNNYXApKTsgICAgICAgICAgICBcclxuICAgICAgICAgfVxyXG4gICAgICAgICBcclxuICAgICAgICAgcmV0dXJuIChjYW5kaWRhdGUuY2hlY2thYmxlICE9PSBmYWxzZSk7IC8vIGhhbmRsZXMgY2lyY3VsYXIgZ3JhcGggYmVjYXVzZSBzZWVuID0gdHJ1ZSBidXQgY2hlY2thYmxlID0gdW5kZWZpZW5kXHJcbiAgICAgIH1cclxuICAgfVxyXG4gICBcclxuXHQvKlxyXG5cdFx0UmV0dXJucyB0aGUgZGlhZ25vc3RpY3MgZm9yIHRoaXMgZmlsZSBhbmQgYW55IGZpbGVzIHdoaWNoIGl0IHVzZXMuXHJcblx0XHRFYWNoIGZpbGUgaXMgb25seSBjaGVja2VkIG9uY2UuXHJcblx0Ki9cclxuXHRwcml2YXRlIGdldEFsbERpYWdub3N0aWNzKGNhbmRpZGF0ZXM6IENhbmRpZGF0ZVtdKTogdHMuRGlhZ25vc3RpY1tdIHtcclxuXHRcdC8vIGhhY2sgdG8gc3VwcG9ydCBodG1sIGltcG9ydHNcclxuICAgICAgbGV0IGZpbGVsaXN0ID0gY2FuZGlkYXRlcy5tYXAoKGRlcCkgPT4gZGVwLm5hbWUpLmNvbmNhdChbX19IVE1MX01PRFVMRV9fXSk7XHJcblx0XHRsZXQgcHJvZ3JhbSA9IHRzLmNyZWF0ZVByb2dyYW0oZmlsZWxpc3QsIHRoaXMuX29wdGlvbnMsIHRoaXMuX2hvc3QpO1xyXG5cclxuXHRcdHJldHVybiBjYW5kaWRhdGVzLnJlZHVjZSgoZXJyb3JzLCBjYW5kaWRhdGUpID0+IHtcclxuXHRcdFx0aWYgKGNhbmRpZGF0ZS5jaGVja2FibGUgJiYgIWNhbmRpZGF0ZS5maWxlLmNoZWNrZWQpIHtcclxuICAgICAgICAgICAgY2FuZGlkYXRlLmZpbGUuZXJyb3JzID0gW107XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBpZiAoIWNhbmRpZGF0ZS5maWxlLmlzTGliRmlsZSkge1xyXG4gICAgICAgICAgICAgICBjYW5kaWRhdGUuZmlsZS5lcnJvcnMgPSBwcm9ncmFtLmdldFN5bnRhY3RpY0RpYWdub3N0aWNzKGNhbmRpZGF0ZS5maWxlKVxyXG4gICAgICAgICAgICAgICAgICAuY29uY2F0KHByb2dyYW0uZ2V0U2VtYW50aWNEaWFnbm9zdGljcyhjYW5kaWRhdGUuZmlsZSkpO1xyXG4gICAgICAgICAgICB9ICAgICAgICAgICAgXHJcblxyXG5cdFx0XHRcdGNhbmRpZGF0ZS5maWxlLmNoZWNrZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICByZXR1cm4gZXJyb3JzLmNvbmNhdChjYW5kaWRhdGUuZmlsZS5lcnJvcnMpO1xyXG5cdFx0XHR9XHJcbiAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gZXJyb3JzO1xyXG4gICAgICAgICB9ICAgICAgICBcdFx0XHRcclxuXHRcdH0sIHByb2dyYW0uZ2V0R2xvYmFsRGlhZ25vc3RpY3MoKSk7XHJcblx0fVxyXG59Il19